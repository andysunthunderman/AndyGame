<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏数据管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9gNqDCx4d-f4EvoH43bBbTqg7O23UzWg"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background-color: #4a90e2;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.5);
        }
        tr:hover {
            background-color: rgba(74, 144, 226, 0.1);
        }
        .filter-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-input {
            padding: 8px 16px;
            border: 1px solid #4a90e2;
            border-radius: 8px;
            min-width: 200px;
        }
        .back-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #4a90e2;
            border-radius: 20px;
            color: #4a90e2;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .back-button:hover {
            background: #4a90e2;
            color: white;
        }
        .tab-button {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #4a90e2;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom-color: #4a90e2;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }
        .error {
            color: #ff4444;
            padding: 10px;
            text-align: center;
            background: rgba(255, 68, 68, 0.1);
            border-radius: 8px;
            margin: 10px 0;
        }
        #map {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .map-marker-info {
            padding: 10px;
            max-width: 200px;
        }
        .map-controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .map-button {
            padding: 8px 16px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .map-button:hover {
            background: #357abd;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-button">返回主页   </a>
        
        <h1 class="text-3xl font-bold mb-6 text-center">游戏数据管理</h1>
        
        <div class="flex justify-center mb-6">
            <button class="tab-button active" data-tab="scores">游戏记录</button>
            <button class="tab-button" data-tab="locations">位置信息</button>
            <button class="tab-button" data-tab="players">玩家记录</button>
        </div>
        
        <!-- 游戏记录部分 -->
        <div id="scores-section" class="card">
            <h2 class="text-2xl font-bold mb-4">游戏记录</h2>
            
            <div class="filter-section">
                <input type="text" id="playerFilter" class="filter-input" placeholder="按玩家名称筛选...">
                <input type="text" id="gameFilter" class="filter-input" placeholder="按游戏名称筛选...">
                <select id="dateFilter" class="filter-input">
                    <option value="">所有日期</option>
                    <option value="today">今天</option>
                    <option value="week">本周</option>
                    <option value="month">本月</option>
                </select>
                <select id="scoreSort" class="filter-input">
                    <option value="">排序方式</option>
                    <option value="highToLow">分数从高到低</option>
                    <option value="lowToHigh">分数从低到高</option>
                </select>
            </div>

            <div class="table-container">
                <table id="scoresTable">
                    <thead>
                        <tr>
                            <th>游戏名称</th>
                            <th>玩家名称</th>
                            <th>分数</th>
                            <th>游戏次数</th>
                            <th>游戏时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" class="loading">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 位置信息部分 -->
        <div id="locations-section" class="card" style="display: none;">
            <h2 class="text-2xl font-bold mb-4">位置信息</h2>
            
            <div class="filter-section">
                <input type="text" id="cityFilter" class="filter-input" placeholder="按城市筛选...">
                <input type="text" id="countryFilter" class="filter-input" placeholder="按国家筛选...">
                <select id="timeFilter" class="filter-input">
                    <option value="">所有时间</option>
                    <option value="today">今天</option>
                    <option value="week">本周</option>
                    <option value="month">本月</option>
                </select>
            </div>

            <!-- 添加地图控制按钮 -->
            <div class="map-controls">
                <button id="toggleView" class="map-button">切换视图</button>
                <button id="centerMap" class="map-button">居中显示</button>
                <span id="totalLocations" class="text-gray-600"></span>
            </div>

            <!-- 添加地图容器 -->
            <div id="map"></div>

            <div class="table-container" id="locationTable">
                <table id="locationsTable">
                    <thead>
                        <tr>
                            <th>城市</th>
                            <th>国家</th>
                            <th>纬度</th>
                            <th>经度</th>
                            <th>记录时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" class="loading">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 添加玩家记录部分 -->
        <div id="players-section" class="card" style="display: none;">
            <h2 class="text-2xl font-bold mb-4">玩家记录</h2>
            
            <div class="filter-section">
                <input type="text" id="playerNameFilter" class="filter-input" placeholder="按玩家昵称筛选...">
            </div>

            <div class="table-container">
                <table id="playersTable">
                    <thead>
                        <tr>
                            <th>玩家昵称</th>
                            <th>最后登录时间</th>
                            <th>访问次数</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" class="loading">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let map;
        let markers = [];
        let bounds;
        let currentLocations = [];
        let isMapView = true;

        // 添加登录验证检查
        function checkLogin() {
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const fromLogin = urlParams.get('from') === 'login';
            
            // 如果不是从登录页面跳转来的，则重定向到登录页面
            if (!fromLogin) {
                window.location.href = 'test-login.html';
                return;
            }
        }

        // 在页面加载时进行登录检查
        document.addEventListener('DOMContentLoaded', () => {
            checkLogin();
            initPage();
            initMap();
        });

        // 初始化地图
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 35.8617, lng: 104.1954 }, // 中国中心位置
                zoom: 4,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });
            bounds = new google.maps.LatLngBounds();
        }

        // 更新地图标记
        function updateMapMarkers(locations) {
            // 清除现有标记
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            bounds = new google.maps.LatLngBounds();

            // 添加新标记
            locations.forEach(location => {
                const position = {
                    lat: parseFloat(location.latitude),
                    lng: parseFloat(location.longitude)
                };

                const marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: `${location.city}, ${location.country}`
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div class="map-marker-info">
                            <h3 style="font-weight: bold; margin-bottom: 5px;">${location.city}</h3>
                            <p>国家: ${location.country}</p>
                            <p>纬度: ${location.latitude}</p>
                            <p>经度: ${location.longitude}</p>
                            <p>记录时间: ${location.created_at}</p>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
                bounds.extend(position);
            });

            // 更新位置计数
            document.getElementById('totalLocations').textContent = 
                `共 ${locations.length} 个位置记录`;
        }

        // 获取游戏记录数据
        async function fetchGameScores() {
            try {
                const response = await fetch('/api/data?action=get_scores');
                const data = await response.json();
                if (data.success) {
                    return data.scores;
                } else {
                    throw new Error(data.error || '获取游戏记录失败');
                }
            } catch (error) {
                console.error('获取游戏记录出错:', error);
                showError('获取游戏记录失败，请稍后重试');
                return [];
            }
        }

        // 获取位置信息数据
        async function fetchLocations() {
            try {
                const response = await fetch('/api/data?action=get_locations');
                const data = await response.json();
                if (data.success) {
                    return data.locations;
                } else {
                    throw new Error(data.error || '获取位置信息失败');
                }
            } catch (error) {
                console.error('获取位置信息出错:', error);
                showError('获取位置信息失败，请稍后重试');
                return [];
            }
        }

        // 显示错误信息
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.card'));
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // 更新游戏记录表格    
        function updateScoresTable(scores, filters = {}) {
            const tbody = document.querySelector('#scoresTable tbody');
            let filteredScores = [...scores];

            // 应用筛选
            if (filters.player) {
                filteredScores = filteredScores.filter(score => 
                    score.player_name.toLowerCase().includes(filters.player.toLowerCase())
                );
            }
            if (filters.game) {
                filteredScores = filteredScores.filter(score => 
                    score.game_name.toLowerCase().includes(filters.game.toLowerCase())
                );
            }
            if (filters.date) {
                const now = new Date();
                const scoreDate = new Date(score.play_date);
                switch(filters.date) {
                    case 'today':
                        filteredScores = filteredScores.filter(score => 
                            new Date(score.play_date).toDateString() === now.toDateString()
                        );
                        break;
                    case 'week':
                        const weekAgo = new Date(now.setDate(now.getDate() - 7));
                        filteredScores = filteredScores.filter(score => 
                            new Date(score.play_date) >= weekAgo
                        );
                        break;
                    case 'month':
                        const monthAgo = new Date(now.setMonth(now.getMonth() - 1));
                        filteredScores = filteredScores.filter(score => 
                            new Date(score.play_date) >= monthAgo
                        );
                        break;
                }
            }

            // 应用排序
            if (filters.sort) {
                filteredScores.sort((a, b) => {
                    return filters.sort === 'highToLow' ? 
                        b.score - a.score : 
                        a.score - b.score;
                });
            }

            // 更新表格内容
            tbody.innerHTML = filteredScores.length ? 
                filteredScores.map(score => `
                    <tr>
                        <td>${score.game_name}</td>
                        <td>${score.player_name}</td>
                        <td>${score.score}</td>
                        <td>${score.play_count}</td>
                        <td>${score.play_date} ${score.play_time}</td>
                    </tr>
                `).join('') :
                '<tr><td colspan="5" class="text-center">没有找到匹配的记录</td></tr>';
        }

        // 修改 updateLocationsTable 函数
        function updateLocationsTable(locations, filters = {}) {
            const tbody = document.querySelector('#locationsTable tbody');
            let filteredLocations = [...locations];

            // 应用筛选
            if (filters.city) {
                filteredLocations = filteredLocations.filter(location => 
                    location.city.toLowerCase().includes(filters.city.toLowerCase())
                );
            }
            if (filters.country) {
                filteredLocations = filteredLocations.filter(location => 
                    location.country.toLowerCase().includes(filters.country.toLowerCase())
                );
            }
            if (filters.time) {
                const now = new Date();
                switch(filters.time) {
                    case 'today':
                        filteredLocations = filteredLocations.filter(location => 
                            new Date(location.created_at).toDateString() === now.toDateString()
                        );
                        break;
                    case 'week':
                        const weekAgo = new Date(now.setDate(now.getDate() - 7));
                        filteredLocations = filteredLocations.filter(location => 
                            new Date(location.created_at) >= weekAgo
                        );
                        break;
                    case 'month':
                        const monthAgo = new Date(now.setMonth(now.getMonth() - 1));
                        filteredLocations = filteredLocations.filter(location => 
                            new Date(location.created_at) >= monthAgo
                        );
                        break;
                }
            }

            // 更新地图标记
            currentLocations = filteredLocations;
            updateMapMarkers(filteredLocations);

            // 更新表格内容
            tbody.innerHTML = filteredLocations.length ? 
                filteredLocations.map(location => `
                    <tr>
                        <td>${location.city}</td>
                        <td>${location.country}</td>
                        <td>${location.latitude}</td>
                        <td>${location.longitude}</td>
                        <td>${location.created_at}</td>
                    </tr>
                `).join('') :
                '<tr><td colspan="5" class="text-center">没有找到匹配的记录</td></tr>';
        }

        // 修改 initPage 函数
        async function initPage() {
            // 初始化地图
            initMap();

            const scores = await fetchGameScores();
            const locations = await fetchLocations();
            
            // 初始化表格
            updateScoresTable(scores);
            updateLocationsTable(locations);
            updatePlayersTable();

            // 标签切换
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    const tabId = button.dataset.tab;
                    document.getElementById('scores-section').style.display = 
                        tabId === 'scores' ? 'block' : 'none';
                    document.getElementById('locations-section').style.display = 
                        tabId === 'locations' ? 'block' : 'none';
                    document.getElementById('players-section').style.display = 
                        tabId === 'players' ? 'block' : 'none';

                    if (tabId === 'locations' && map) {
                        google.maps.event.trigger(map, 'resize');
                        if (bounds.isEmpty()) {
                            map.setCenter({ lat: 35.8617, lng: 104.1954 });
                            map.setZoom(4);
                        } else {
                            map.fitBounds(bounds);
                        }
                    }
                });
            });

            // 游戏记录筛选器
            const playerFilter = document.getElementById('playerFilter');
            const gameFilter = document.getElementById('gameFilter');
            const dateFilter = document.getElementById('dateFilter');
            const scoreSort = document.getElementById('scoreSort');

            function updateScoresFilters() {
                updateScoresTable(scores, {
                    player: playerFilter.value,
                    game: gameFilter.value,
                    date: dateFilter.value,
                    sort: scoreSort.value
                });
            }

            playerFilter.addEventListener('input', updateScoresFilters);
            gameFilter.addEventListener('input', updateScoresFilters);
            dateFilter.addEventListener('change', updateScoresFilters);
            scoreSort.addEventListener('change', updateScoresFilters);

            // 位置信息筛选器
            const cityFilter = document.getElementById('cityFilter');
            const countryFilter = document.getElementById('countryFilter');
            const timeFilter = document.getElementById('timeFilter');

            function updateLocationsFilters() {
                updateLocationsTable(locations, {
                    city: cityFilter.value,
                    country: countryFilter.value,
                    time: timeFilter.value
                });
            }

            cityFilter.addEventListener('input', updateLocationsFilters);
            countryFilter.addEventListener('input', updateLocationsFilters);
            timeFilter.addEventListener('change', updateLocationsFilters);

            // 玩家记录筛选器
            const playerNameFilter = document.getElementById('playerNameFilter');
            playerNameFilter.addEventListener('input', () => {
                updatePlayersTable(playerNameFilter.value);
            });

            // 添加地图控制按钮事件
            document.getElementById('toggleView').addEventListener('click', () => {
                isMapView = !isMapView;
                document.getElementById('map').style.display = isMapView ? 'block' : 'none';
                document.getElementById('locationTable').style.display = isMapView ? 'none' : 'block';
                document.getElementById('toggleView').textContent = isMapView ? '显示表格' : '显示地图';
                
                if (isMapView) {
                    google.maps.event.trigger(map, 'resize');
                    if (!bounds.isEmpty()) {
                        map.fitBounds(bounds);
                    }
                }
            });

            document.getElementById('centerMap').addEventListener('click', () => {
                if (!bounds.isEmpty()) {
                    map.fitBounds(bounds);
                }
            });
        }

        // 添加更新玩家表格的函数
        function updatePlayersTable(filter = '') {
            const players = JSON.parse(localStorage.getItem('players') || '[]');
            const tbody = document.querySelector('#playersTable tbody');
            
            let filteredPlayers = players;
            if (filter) {
                filteredPlayers = players.filter(player => 
                    player.nickname.toLowerCase().includes(filter.toLowerCase())
                );
            }

            tbody.innerHTML = filteredPlayers.length ? 
                filteredPlayers.map(player => `
                    <tr>
                        <td>${player.nickname}</td>
                        <td>${player.loginTime}</td>
                        <td>${player.visits}</td>
                    </tr>
                `).join('') :
                '<tr><td colspan="3" class="text-center">没有找到匹配的记录</td></tr>';
        }
    </script>
</body>
</html> 