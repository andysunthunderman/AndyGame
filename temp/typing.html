<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>打字挑战</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        .game-container {
            background: rgba(255, 255, 255, 0.9);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
            text-align: center;
        }
        .text-display {
            font-size: 1.5rem;
            margin: 2rem 0;
            padding: 1rem;
            border-radius: 0.5rem;
            background: #f8f9fa;
            line-height: 1.6;
            text-align: left;
            white-space: pre-wrap;
            min-height: 150px;
        }
        .text-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.2rem;
            border: 2px solid #4a5568;
            border-radius: 0.5rem;
            margin: 1rem 0;
            background: white;
        }
        .text-input:focus {
            outline: none;
            border-color: #4c51bf;
            box-shadow: 0 0 0 3px rgba(76, 81, 191, 0.2);
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 2rem 0;
            font-size: 1.2rem;
        }
        .stat-item {
            background: #4c51bf;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            min-width: 120px;
        }
        .back-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: #4a5568;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        .correct {
            color: #48bb78;
        }
        .incorrect {
            color: #e53e3e;
            text-decoration: underline;
        }
        .current {
            background-color: #ebf4ff;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-button">返回主页</a>
    
    <div class="game-container">
        <h1 class="text-4xl font-bold mb-4">打字挑战</h1>
        
        <div class="stats">
            <div class="stat-item">
                <div>速度</div>
                <div id="wpm">0 WPM</div>
            </div>
            <div class="stat-item">
                <div>准确率</div>
                <div id="accuracy">100%</div>
            </div>
            <div class="stat-item">
                <div>时间</div>
                <div id="timer">60s</div>
            </div>
        </div>

        <div id="text-display" class="text-display"></div>
        <textarea id="text-input" class="text-input" placeholder="准备好后点击这里开始打字..." rows="3"></textarea>
        
        <div class="flex space-x-4 justify-center">
            <button id="start-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-300">
                开始新游戏
            </button>
            <button id="difficulty-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-300">
                难度：中等
            </button>
            <button id="language-btn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-300">
                语言：中文
            </button>
        </div>
    </div>

    <script>
        // 修改记录成绩函数
        async function recordGameScore(gameName, score) {
            try {
                const today = new Date().toLocaleDateString('zh-CN');
                const scores = JSON.parse(localStorage.getItem('gameScores')) || {};
                
                if (!scores[today]) {
                    scores[today] = {};
                }
                
                if (!scores[today][gameName]) {
                    scores[today][gameName] = {
                        highScore: score,
                        playCount: 1,
                        lastPlayed: new Date().toLocaleTimeString('zh-CN')
                    };
                } else {
                    scores[today][gameName].playCount += 1;
                    scores[today][gameName].lastPlayed = new Date().toLocaleTimeString('zh-CN');
                    if (score > scores[today][gameName].highScore) {
                        scores[today][gameName].highScore = score;
                    }
                }
                
                localStorage.setItem('gameScores', JSON.stringify(scores));

                // 保存到数据库
                const response = await fetch('/api/data?action=save_score', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        gameName: gameName,
                        score: score,
                        playCount: scores[today][gameName].playCount,
                        playerName: localStorage.getItem('playerName') || '匿名玩家'
                    })
                });

                const result = await response.json();
                if (!result.success) {
                    console.error('保存成绩到数据库失败:', result.error);
                }
            } catch (error) {
                console.error('保存成绩时出错:', error);
            }
        }

        // 添加保存位置信息的函数
        async function savePlayerLocation(position) {
            try {
                const { latitude, longitude } = position.coords;
                
                // 使用和风天气API获取城市信息
                const apiKey = 'eaf13cf8435b479ea03f4cb95506f413';
                const locationResponse = await fetch(`https://geoapi.qweather.com/v2/city/lookup?location=${longitude},${latitude}&key=${apiKey}`);
                const locationData = await locationResponse.json();
                
                const city = locationData.location?.[0]?.name || '未知城市';
                const country = locationData.location?.[0]?.country || '未知国家';

                // 保存到数据库
                const user = JSON.parse(localStorage.getItem('user'));
                const userId = user ? user.id : null;

                const response = await fetch('/api/data?action=save_location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        latitude,
                        longitude,
                        city,
                        country,
                        userId
                    })
                });

                const result = await response.json();
                if (!result.success) {
                    console.error('保存位置信息到数据库失败:', result.error);
                }
            } catch (error) {
                console.error('保存位置信息时出错:', error);
            }
        }

        const textDisplay = document.getElementById('text-display');
        const textInput = document.getElementById('text-input');
        const wpmDisplay = document.getElementById('wpm');
        const accuracyDisplay = document.getElementById('accuracy');
        const timerDisplay = document.getElementById('timer');
        const startButton = document.getElementById('start-btn');
        const difficultyButton = document.getElementById('difficulty-btn');
        const languageButton = document.getElementById('language-btn');

        let timeLeft = 60;
        let timer = null;
        let isGameActive = false;
        let startTime = null;
        let totalTyped = 0;
        let correctTyped = 0;
        let currentWordIndex = 0;
        let difficulty = 'medium';
        let currentLanguage = 'zh'; // 'zh' for Chinese, 'en' for English

        const texts = {
            zh: {
                easy: [
                    "春天来了，花儿开了，小鸟在枝头唱歌。",
                    "我们都是好朋友，一起学习一起玩。",
                    "明天就要去远足了，我准备好了背包和水壶。",
                    "小猫在院子里追蝴蝶，真可爱。",
                    "放学后，我喜欢在公园里荡秋千。"
                ],
                medium: [
                    "科技的发展日新月异，人工智能正在改变我们的生活方式。",
                    "环境保护需要每个人的参与，从点滴做起，从现在开始。",
                    "学习是一个永无止境的过程，要保持持续学习的热情。",
                    "健康的生活方式包括均衡的饮食和适量的运动。",
                    "团队合作是现代社会中不可或缺的重要能力。"
                ],
                hard: [
                    "在信息技术高速发展的今天，如何保护个人隐私成为一个值得深思的问题。",
                    "可持续发展战略的实施需要政府、企业和个人的共同努力。",
                    "随着经济全球化的深入，跨文化交际能力变得越来越重要。",
                    "人工智能的伦理问题引发了学术界和产业界的广泛讨论。",
                    "在竞争激烈的职场中，终身学习成为适应社会发展的必要选择。"
                ]
            },
            en: {
                easy: [
                    "The quick brown fox jumps over the lazy dog.",
                    "She sells seashells by the seashore.",
                    "A beautiful rainbow appeared after the rain.",
                    "The sun rises in the east and sets in the west.",
                    "Children love to play in the park on sunny days."
                ],
                medium: [
                    "Technology is rapidly changing the way we live and work in modern society.",
                    "Environmental protection requires everyone's participation and commitment.",
                    "Learning is a lifelong journey that never truly ends.",
                    "A healthy lifestyle includes balanced diet and regular exercise.",
                    "Effective teamwork is essential for success in today's workplace."
                ],
                hard: [
                    "The implementation of sustainable development strategies requires collaboration between governments and corporations.",
                    "In today's rapidly evolving digital landscape, protecting personal privacy has become increasingly challenging.",
                    "The advancement of artificial intelligence raises important ethical considerations for society.",
                    "Cross-cultural communication skills are becoming increasingly valuable in our globalized world.",
                    "Professional development and continuous learning are crucial for career advancement in competitive industries."
                ]
            }
        };

        function getRandomText() {
            const textArray = texts[currentLanguage][difficulty];
            return textArray[Math.floor(Math.random() * textArray.length)];
        }

        function updateDisplay() {
            const words = textDisplay.textContent.split('');
            const typed = textInput.value.split('');
            let displayHTML = '';
            
            words.forEach((char, index) => {
                if (index >= typed.length) {
                    displayHTML += `<span>${char}</span>`;
                } else if (char === typed[index]) {
                    displayHTML += `<span class="correct">${char}</span>`;
                    correctTyped++;
                } else {
                    displayHTML += `<span class="incorrect">${char}</span>`;
                }
                totalTyped++;
            });
            
            textDisplay.innerHTML = displayHTML;
        }

        function calculateWPM() {
            if (!startTime) return 0;
            const timeElapsed = (Date.now() - startTime) / 1000 / 60; // in minutes
            // 中文每个字符算一个字，英文每5个字符算一个词
            const wordCount = currentLanguage === 'zh' ? 
                correctTyped : 
                Math.round(correctTyped / 5);
            return Math.round(wordCount / timeElapsed);
        }

        function calculateAccuracy() {
            if (totalTyped === 0) return 100;
            return Math.round((correctTyped / totalTyped) * 100);
        }

        function startGame() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(savePlayerLocation, null, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                });
            }

            textDisplay.textContent = getRandomText();
            textInput.value = '';
            textInput.disabled = false;
            timeLeft = 60;
            isGameActive = true;
            startTime = Date.now();
            totalTyped = 0;
            correctTyped = 0;
            
            if (timer) clearInterval(timer);
            timer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft + 's';
                
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
            
            textInput.focus();
        }

        function endGame() {
            clearInterval(timer);
            isGameActive = false;
            textInput.disabled = true;
            
            const finalWPM = calculateWPM();
            const finalAccuracy = calculateAccuracy();
            const finalScore = Math.round(finalWPM * (finalAccuracy / 100));
            
            // 记录游戏成绩
            recordGameScore("打字挑战", finalScore);
            
            const message = currentLanguage === 'zh' ? 
                `游戏结束！\n打字速度：${finalWPM} WPM\n准确率：${finalAccuracy}%\n最终得分：${finalScore}` :
                `Game Over!\nTyping Speed: ${finalWPM} WPM\nAccuracy: ${finalAccuracy}%\nFinal Score: ${finalScore}`;
            
            alert(message);
        }

        function toggleDifficulty() {
            switch(difficulty) {
                case 'easy':
                    difficulty = 'medium';
                    difficultyButton.textContent = '难度：中等';
                    difficultyButton.className = 'px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-300';
                    break;
                case 'medium':
                    difficulty = 'hard';
                    difficultyButton.textContent = '难度：困难';
                    difficultyButton.className = 'px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-300';
                    break;
                case 'hard':
                    difficulty = 'easy';
                    difficultyButton.textContent = '难度：简单';
                    difficultyButton.className = 'px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300';
                    break;
            }
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
            languageButton.textContent = currentLanguage === 'zh' ? '语言：中文' : 'Language: English';
            
            // 如果游戏正在进行，重新开始游戏以更新文本
            if (isGameActive) {
                startGame();
            } else {
                textDisplay.textContent = '准备好后点击"开始新游戏"按钮开始挑战';
            }
        }

        startButton.addEventListener('click', startGame);
        difficultyButton.addEventListener('click', toggleDifficulty);
        languageButton.addEventListener('click', toggleLanguage);

        textInput.addEventListener('input', () => {
            if (!isGameActive) return;
            
            updateDisplay();
            wpmDisplay.textContent = calculateWPM() + ' WPM';
            accuracyDisplay.textContent = calculateAccuracy() + '%';
            
            if (textInput.value.length === textDisplay.textContent.length) {
                startGame();
            }
        });

        // 初始化显示
        textDisplay.textContent = '准备好后点击"开始新游戏"按钮开始挑战';
        textInput.disabled = true;
    </script>
</body>
</html> 