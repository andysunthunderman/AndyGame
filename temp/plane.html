<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飞机大战-完整暂停版</title>
    <!-- 引入第三方库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #000; 
            font-family: 'Orbitron', sans-serif;
        }
        canvas { 
            border: 2px solid #30cfd0; 
            box-shadow: 0 0 20px #30cfd0;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        #hud { 
            position: fixed; 
            top: 10px; 
            left: 10px; 
            color: #30cfd0; 
            font-size: 18px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #30cfd0;
            z-index: 20;
            text-shadow: 0 0 5px #30cfd0;
        }
        .button { 
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%);
            background: #330867;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            border-radius: 30px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 0 15px #30cfd0;
            transition: all 0.3s ease;
            z-index: 20;
        }
        .button:hover {
            background: #30cfd0;
            box-shadow: 0 0 25px #30cfd0;
        }
        .back-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 8px;
            text-decoration: none;
            transition: background 0.3s ease;
            z-index: 100;
        }
        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        #gameOverScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 30;
        }
        #gameOverScreen h1 {
            color: #FF5252;
            font-size: 50px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #FF5252;
        }
        #gameOverScreen p {
            color: white;
            font-size: 24px;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div id="hud">
        <div>时间: <span id="timer">0</span>s</div>
        <div>生命: <span id="life">3</span></div>
        <div>分数: <span id="score">0</span></div>
        <div>最高分: <span id="highscore">0</span></div>
        <div>弹药: <span id="ammo">30</span></div>
    </div>
    <a href="index.html" class="back-button">返回主页</a>
    <button id="restart" class="button" style="display:none;">重新开始</button>
    <canvas id="game"></canvas>
    
    <div id="gameOverScreen">
        <h1>游戏结束</h1>
        <p>你的分数: <span id="finalScore">0</span></p>
        <button id="restartFromGameOver" class="button">再来一次</button>
    </div>

<script>
const config = {
    canvas: document.getElementById('game'),
    ctx: null,
    WIDTH: 1200,
    HEIGHT: 800,
    keys: {},
    player: {
        x: 575,
        y: 700,
        width: 70,
        height: 70,
        speed: 8,
        bullets: [],
        ammo: 30,
        reloading: false,
        canShoot: true
    },
    enemies: [],
    enemyBullets: [],
    medkit: {
        active: false,
        x: 0,
        y: 0,
        width: 40,
        height: 40,
        spawnTimer: 0
    },
    gameTime: 0,
    startTime: 0,
    paused: false,
    pauseTime: 0,
    bullets: [],
    score: 0,
    highScore: localStorage.getItem('highScore') || 0,
    life: 3,
    gameOver: false,
    // 添加图像和音效
    images: {},
    // 添加粒子效果
    explosions: []
};

// 初始化粒子背景
function initParticles() {
    particlesJS('particles-js', {
        "particles": {
            "number": {
                "value": 100,
                "density": {
                    "enable": true,
                    "value_area": 800
                }
            },
            "color": {
                "value": "#ffffff"
            },
            "shape": {
                "type": "circle",
                "stroke": {
                    "width": 0,
                    "color": "#000000"
                },
                "polygon": {
                    "nb_sides": 5
                }
            },
            "opacity": {
                "value": 0.5,
                "random": true,
                "anim": {
                    "enable": true,
                    "speed": 1,
                    "opacity_min": 0.1,
                    "sync": false
                }
            },
            "size": {
                "value": 3,
                "random": true,
                "anim": {
                    "enable": true,
                    "speed": 2,
                    "size_min": 0.1,
                    "sync": false
                }
            },
            "line_linked": {
                "enable": false
            },
            "move": {
                "enable": true,
                "speed": 0.5,
                "direction": "none",
                "random": true,
                "straight": false,
                "out_mode": "out",
                "bounce": false,
                "attract": {
                    "enable": false,
                    "rotateX": 600,
                    "rotateY": 1200
                }
            }
        },
        "interactivity": {
            "detect_on": "canvas",
            "events": {
                "onhover": {
                    "enable": false
                },
                "onclick": {
                    "enable": false
                },
                "resize": true
            }
        },
        "retina_detect": true
    });
}

function init() {
    config.ctx = config.canvas.getContext('2d');
    config.canvas.width = config.WIDTH;
    config.canvas.height = config.HEIGHT;
    
    config.startTime = Date.now();
    config.gameTime = 0;
    
    document.addEventListener('keydown', e => {
        config.keys[e.key] = true;
        if(e.key === 'e') togglePause();
    });
    document.addEventListener('keyup', e => config.keys[e.key] = false);
    
    document.getElementById('restart').addEventListener('click', () => {
        resetGame();
        gameLoop();
    });
    
    document.getElementById('restartFromGameOver').addEventListener('click', () => {
        document.getElementById('gameOverScreen').style.display = 'none';
        resetGame();
        gameLoop();
    });

    setInterval(() => {
        if(!config.medkit.active && !config.gameOver && !config.paused) {
            spawnMedkit();
        }
    }, 50000);

    document.getElementById('highscore').textContent = config.highScore;
    
    // 初始化粒子背景
    initParticles();
    
    gameLoop();
}

function resetGame() {
    config.life = 3;
    config.score = 0;
    config.gameOver = false;
    config.player.ammo = 30;
    config.player.reloading = false;
    config.medkit.active = false;
    config.enemies = [];
    config.enemyBullets = [];
    config.player.bullets = [];
    config.explosions = [];
    config.startTime = Date.now();
    config.gameTime = 0;
    document.getElementById('restart').style.display = 'none';
}

function togglePause() {
    if(config.gameOver) return;
    
    config.paused = !config.paused;
    if(config.paused) {
        config.pauseTime = Date.now();
    } else {
        config.startTime += Date.now() - config.pauseTime;
        // 恢复所有敌人的计时器
        config.enemies.forEach(enemy => {
            enemy.lastFire += Date.now() - config.pauseTime;
        });
    }
}

function spawnMedkit() {
    config.medkit.active = true;
    config.medkit.x = Math.random() * (config.WIDTH - 40);
    config.medkit.y = Math.random() * (config.HEIGHT - 40);
    
    // 添加出现动画
    gsap.from({x: config.medkit.x, y: config.medkit.y}, {
        duration: 0.5,
        scale: 0,
        ease: "back.out(1.7)",
        onUpdate: function() {
            // 这里可以添加更新逻辑
        }
    });
}

function controlPlayer() {
    if(config.paused || config.gameOver) return;
    
    if(config.keys.w && config.player.y > 0) config.player.y -= config.player.speed;
    if(config.keys.s && config.player.y < config.HEIGHT - 50) config.player.y += config.player.speed;
    if(config.keys.a && config.player.x > 0) config.player.x -= config.player.speed;
    if(config.keys.d && config.player.x < config.WIDTH - 50) config.player.x += config.player.speed;
    
    if(config.keys[' '] && config.player.canShoot && !config.player.reloading) {
        if(config.player.ammo > 0) {
            config.player.bullets.push({
                x: config.player.x + 30,
                y: config.player.y,
                width: 12,
                height: 24,
                speed: 10
            });
            config.player.ammo--;
            config.player.canShoot = false;
            setTimeout(() => config.player.canShoot = true, 200);
            
            if(config.player.ammo === 0) {
                config.player.reloading = true;
                setTimeout(() => {
                    config.player.ammo = 30;
                    config.player.reloading = false;
                }, 1500);
            }
        }
    }
}

// 添加爆炸效果
function createExplosion(x, y) {
    config.explosions.push({
        x: x,
        y: y,
        radius: 5,
        maxRadius: 30,
        alpha: 1,
        growing: true
    });
}

// 修改后的敌人生成逻辑
function spawnEnemy() {
    if(Math.random() < 0.04 && !config.paused) {
        const enemy = {
            x: Math.random() * (config.WIDTH - 50),
            y: -50,
            width: 50,
            height: 50,
            speed: 3 + Math.random() * 4,
            health: 1,
            fireCooldown: Math.random() * 2000 + 1000,
            lastFire: Date.now()
        };
        config.enemies.push(enemy);
        
        // 添加入场动画
        gsap.from({x: enemy.x, y: enemy.y}, {
            duration: 0.5,
            y: "-=50",
            ease: "power2.out"
        });
    }
}

// 修改后的敌人射击逻辑
function enemyFire() {
    config.enemies.forEach(enemy => {
        if(Date.now() - enemy.lastFire > enemy.fireCooldown && !config.paused) {
            config.enemyBullets.push({
                x: enemy.x + 25,
                y: enemy.y + 50,
                width: 10,
                height: 24,
                speed: 5
            });
            enemy.lastFire = Date.now();
            enemy.fireCooldown = Math.random() * 2000 + 1000;
        }
    });
}

function checkCollision(rect1, rect2) {
    return rect1.x < rect2.x + rect2.width &&
           rect1.x + rect1.width > rect2.x &&
           rect1.y < rect2.y + rect2.height &&
           rect1.y + rect1.height > rect2.y;
}

function checkBulletCollision() {
    for (let i = config.player.bullets.length - 1; i >= 0; i--) {
        for (let j = config.enemyBullets.length - 1; j >= 0; j--) {
            if (checkCollision(config.player.bullets[i], config.enemyBullets[j])) {
                createExplosion(config.enemyBullets[j].x, config.enemyBullets[j].y);
                config.player.bullets.splice(i, 1);
                config.enemyBullets.splice(j, 1);
                break;
            }
        }
    }
}

function checkMedkitCollision() {
    if(config.medkit.active && checkCollision(config.player, config.medkit)) {
        config.life = Math.min(3, config.life + 1);
        config.medkit.active = false;
        
        // 添加生命值增加动画
        const lifeElement = document.getElementById('life');
        gsap.from(lifeElement, {
            duration: 0.5,
            scale: 2,
            color: "#00FF00",
            ease: "elastic.out(1, 0.3)",
            clearProps: "all"
        });
    }
}

function updateTimer() {
    if(!config.paused && !config.gameOver) {
        config.gameTime = Math.floor((Date.now() - config.startTime) / 1000);
        document.getElementById('timer').textContent = config.gameTime;
    }
}

// 更新爆炸效果
function updateExplosions() {
    for (let i = config.explosions.length - 1; i >= 0; i--) {
        const explosion = config.explosions[i];
        
        if (explosion.growing) {
            explosion.radius += 2;
            if (explosion.radius >= explosion.maxRadius) {
                explosion.growing = false;
            }
        } else {
            explosion.alpha -= 0.05;
            if (explosion.alpha <= 0) {
                config.explosions.splice(i, 1);
                continue;
            }
        }
        
        config.ctx.beginPath();
        config.ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
        config.ctx.fillStyle = `rgba(255, 165, 0, ${explosion.alpha})`;
        config.ctx.fill();
        
        config.ctx.beginPath();
        config.ctx.arc(explosion.x, explosion.y, explosion.radius * 0.7, 0, Math.PI * 2);
        config.ctx.fillStyle = `rgba(255, 255, 0, ${explosion.alpha})`;
        config.ctx.fill();
    }
}

function gameLoop() {
    if(config.gameOver) return;
    
    updateTimer();
    
    // 绘制星空背景
    config.ctx.fillStyle = '#000';
    config.ctx.fillRect(0, 0, config.WIDTH, config.HEIGHT);
    
    // 绘制星星
    for (let i = 0; i < 50; i++) {
        const x = Math.random() * config.WIDTH;
        const y = Math.random() * config.HEIGHT;
        const size = Math.random() * 2;
        const brightness = Math.random() * 50 + 50;
        
        config.ctx.fillStyle = `rgba(255, 255, 255, ${brightness/100})`;
        config.ctx.fillRect(x, y, size, size);
    }
    
    if(!config.paused) controlPlayer();
    
    spawnEnemy();
    
    if(!config.paused) enemyFire();
    
    checkBulletCollision();
    checkMedkitCollision();
    
    // 绘制玩家 - 使用渐变色
    const gradient = config.ctx.createLinearGradient(
        config.player.x, config.player.y, 
        config.player.x, config.player.y + config.player.height
    );
    gradient.addColorStop(0, '#30cfd0');
    gradient.addColorStop(1, '#330867');
    
    config.ctx.fillStyle = gradient;
    config.ctx.beginPath();
    config.ctx.moveTo(config.player.x + 35, config.player.y);
    config.ctx.lineTo(config.player.x, config.player.y + 70);
    config.ctx.lineTo(config.player.x + 70, config.player.y + 70);
    config.ctx.closePath();
    config.ctx.fill();
    
    // 绘制治疗包 - 使用圆角矩形和内部十字
    if(config.medkit.active) {
        // 外部绿色框
        config.ctx.fillStyle = '#00FF00';
        config.ctx.beginPath();
        config.ctx.roundRect(config.medkit.x, config.medkit.y, 40, 40, 8);
        config.ctx.fill();
        
        // 内部白色十字
        config.ctx.fillStyle = 'white';
        config.ctx.fillRect(config.medkit.x + 15, config.medkit.y + 5, 10, 30);
        config.ctx.fillRect(config.medkit.x + 5, config.medkit.y + 15, 30, 10);
    }
    
    // 更新玩家子弹（暂停时停止移动）
    config.player.bullets.forEach((bullet, i) => {
        if(!config.paused) bullet.y -= bullet.speed;
        
        // 使用渐变色子弹
        const bulletGradient = config.ctx.createLinearGradient(
            bullet.x, bullet.y, 
            bullet.x, bullet.y + bullet.height
        );
        bulletGradient.addColorStop(0, '#FFEB3B');
        bulletGradient.addColorStop(1, '#FF9800');
        
        config.ctx.fillStyle = bulletGradient;
        config.ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
        
        // 添加子弹尾迹
        config.ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
        config.ctx.beginPath();
        config.ctx.moveTo(bullet.x, bullet.y + bullet.height);
        config.ctx.lineTo(bullet.x + bullet.width/2, bullet.y + bullet.height + 10);
        config.ctx.lineTo(bullet.x + bullet.width, bullet.y + bullet.height);
        config.ctx.closePath();
        config.ctx.fill();
        
        config.enemies.forEach((enemy, j) => {
            if(checkCollision(bullet, enemy)) {
                enemy.health--;
                if(enemy.health <= 0) {
                    createExplosion(enemy.x + 15, enemy.y + 15);
                    config.score += 10;
                    config.enemies.splice(j, 1);
                    
                    // 添加分数增加动画
                    const scoreElement = document.getElementById('score');
                    gsap.from(scoreElement, {
                        duration: 0.3,
                        scale: 1.5,
                        color: "#FFEB3B",
                        ease: "power2.out",
                        clearProps: "all"
                    });
                }
                config.player.bullets.splice(i, 1);
            }
        });
        
        if(bullet.y < 0) config.player.bullets.splice(i, 1);
    });
    
    // 更新敌人子弹（暂停时停止移动）
    config.enemyBullets.forEach((bullet, i) => {
        if(!config.paused) bullet.y += bullet.speed;
        
        // 使用渐变色敌人子弹
        const enemyBulletGradient = config.ctx.createLinearGradient(
            bullet.x, bullet.y, 
            bullet.x, bullet.y + bullet.height
        );
        enemyBulletGradient.addColorStop(0, '#F44336');
        enemyBulletGradient.addColorStop(1, '#D50000');
        
        config.ctx.fillStyle = enemyBulletGradient;
        config.ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
        
        if(checkCollision(bullet, config.player)) {
            createExplosion(bullet.x, bullet.y);
            config.life--;
            config.enemyBullets.splice(i, 1);
            
            // 添加生命值减少动画
            const lifeElement = document.getElementById('life');
            gsap.from(lifeElement, {
                duration: 0.3,
                scale: 1.5,
                color: "#F44336",
                ease: "power2.out",
                clearProps: "all"
            });
            
            if(config.life <= 0) {
                config.gameOver = true;
                document.getElementById('finalScore').textContent = config.score;
                document.getElementById('gameOverScreen').style.display = 'flex';
                
                // 记录游戏成绩
                recordGameScore("飞机大战", config.score);
                
                if(config.score > config.highScore) {
                    config.highScore = config.score;
                    localStorage.setItem('highScore', config.highScore);
                    document.getElementById('highscore').textContent = config.highScore;
                }
            }
        }
        
        if(bullet.y > config.HEIGHT) config.enemyBullets.splice(i, 1);
    });
    
    // 更新敌人位置（暂停时停止移动）
    config.enemies.forEach((enemy, i) => {
        if(!config.paused) enemy.y += enemy.speed;
        
        // 使用渐变色敌人
        const enemyGradient = config.ctx.createLinearGradient(
            enemy.x, enemy.y, 
            enemy.x, enemy.y + enemy.height
        );
        enemyGradient.addColorStop(0, '#F44336');
        enemyGradient.addColorStop(1, '#D50000');
        
        config.ctx.fillStyle = enemyGradient;
        config.ctx.beginPath();
        config.ctx.moveTo(enemy.x + 25, enemy.y + 50);
        config.ctx.lineTo(enemy.x, enemy.y);
        config.ctx.lineTo(enemy.x + 50, enemy.y);
        config.ctx.closePath();
        config.ctx.fill();
        
        if(checkCollision(enemy, config.player)) {
            createExplosion(enemy.x + 15, enemy.y + 15);
            config.life--;
            config.enemies.splice(i, 1);
            
            // 添加生命值减少动画
            const lifeElement = document.getElementById('life');
            gsap.from(lifeElement, {
                duration: 0.3,
                scale: 1.5,
                color: "#F44336",
                ease: "power2.out",
                clearProps: "all"
            });
            
            if(config.life <= 0) {
                config.gameOver = true;
                document.getElementById('finalScore').textContent = config.score;
                document.getElementById('gameOverScreen').style.display = 'flex';
                
                // 记录游戏成绩
                recordGameScore("飞机大战", config.score);
                
                if(config.score > config.highScore) {
                    config.highScore = config.score;
                    localStorage.setItem('highScore', config.highScore);
                    document.getElementById('highscore').textContent = config.highScore;
                }
            }
        }
        
        if(enemy.y > config.HEIGHT) config.enemies.splice(i, 1);
    });
    
    // 更新爆炸效果
    updateExplosions();
    
    document.getElementById('life').textContent = config.life;
    document.getElementById('score').textContent = config.score;
    document.getElementById('ammo').textContent = 
        config.player.reloading ? "换弹中..." : config.player.ammo;
    
    if(config.paused) {
        config.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        config.ctx.fillRect(0, 0, config.WIDTH, config.HEIGHT);
        
        config.ctx.fillStyle = '#30cfd0';
        config.ctx.font = '48px Orbitron';
        config.ctx.textAlign = 'center';
        config.ctx.fillText('暂停中', config.WIDTH/2, config.HEIGHT/2);
        config.ctx.font = '24px Orbitron';
        config.ctx.fillText('按 E 键继续', config.WIDTH/2, config.HEIGHT/2 + 50);
        config.ctx.textAlign = 'left';
    }
    
    requestAnimationFrame(gameLoop);
}

// 添加记录成绩函数
function recordGameScore(gameName, score) {
    const today = new Date().toLocaleDateString('zh-CN');
    const now = new Date().toLocaleTimeString('zh-CN');
    const scores = JSON.parse(localStorage.getItem('gameScores')) || {};
    
    if (!scores[today]) {
        scores[today] = {};
    }
    
    if (!scores[today][gameName]) {
        scores[today][gameName] = {
            highScore: score,
            playCount: 1,
            lastPlayed: now
        };
    } else {
        const gameData = scores[today][gameName];
        gameData.playCount += 1;
        gameData.lastPlayed = now;
        if (score > gameData.highScore) {
            gameData.highScore = score;
        }
    }
    
    localStorage.setItem('gameScores', JSON.stringify(scores));
}

async function saveScore(score) {
    try {
        const response = await fetch('/api/data?action=save_score', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                gameName: 'plane',
                playerName: localStorage.getItem('playerName') || '匿名玩家',
                score: score,
                playCount: 1
            })
        });
        const data = await response.json();
        if (!data.success) {
            throw new Error(data.error || '保存分数失败');
        }
    } catch (error) {
        console.error('保存分数出错:', error);
    }
}

async function gameOver() {
    config.gameOver = true;
    const finalScore = config.score;
    
    // 记录游戏成绩到数据库
    try {
        await saveScore(finalScore);
    } catch (error) {
        console.error('保存成绩时出错:', error);
    }

    // 同时保存到本地存储
    const today = new Date().toLocaleDateString('zh-CN');
    const scores = JSON.parse(localStorage.getItem('gameScores')) || {};
    
    if (!scores[today]) {
        scores[today] = {};
    }
    
    if (!scores[today]['飞机大战']) {
        scores[today]['飞机大战'] = {
            highScore: finalScore,
            playCount: 1,
            lastPlayed: new Date().toLocaleTimeString('zh-CN')
        };
    } else {
        scores[today]['飞机大战'].playCount += 1;
        scores[today]['飞机大战'].lastPlayed = new Date().toLocaleTimeString('zh-CN');
        if (finalScore > scores[today]['飞机大战'].highScore) {
            scores[today]['飞机大战'].highScore = finalScore;
        }
    }
    
    localStorage.setItem('gameScores', JSON.stringify(scores));
    
    alert(`游戏结束！\n最终得分：${finalScore}`);
    
    // 重置游戏状态
    cancelAnimationFrame(animationId);
    config.ctx.clearRect(0, 0, config.canvas.width, config.canvas.height);
    showGameOver();
}

init();
</script>
</body>
</html>